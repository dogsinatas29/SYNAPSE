import * as vscode from 'vscode';
import * as fs from 'fs';
import * as path from 'path';

/**
 * SYNAPSE Prompt Tracer
 * ë…ë¦½ì ì¸ í”„ë¡¬í”„íŠ¸ ê¸°ë¡ í™•ì¥
 */

export function activate(context: vscode.ExtensionContext) {
    console.log('[SYNAPSE Tracer] Prompt Tracer is now active');

    // synapse.logPrompt ëª…ë ¹ ë“±ë¡
    let disposable = vscode.commands.registerCommand('synapse.logPrompt', async (args: { prompt: string, title?: string, workspacePath?: string }) => {
        const { prompt, title, workspacePath } = args;

        if (!prompt) {
            console.error('[SYNAPSE Tracer] No prompt provided');
            return;
        }

        // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê²½ë¡œ ê²°ì •
        let targetWorkspace: string | undefined = workspacePath;
        if (!targetWorkspace) {
            targetWorkspace = vscode.workspace.workspaceFolders?.[0].uri.fsPath;
        }

        if (!targetWorkspace) {
            vscode.window.showErrorMessage('[SYNAPSE Tracer] No active workspace found to log prompt.');
            return;
        }

        try {
            const filePath = savePrompt(targetWorkspace, prompt, title);
            return { success: true, filePath };
        } catch (error) {
            console.error('[SYNAPSE Tracer] Failed to log prompt:', error);
            vscode.window.showErrorMessage(`[SYNAPSE Tracer] Failed to log prompt: ${error}`);
            return { success: false, error };
        }
    });

    context.subscriptions.push(disposable);

    // ë‹¤ë¥¸ í™•ì¥ì—ì„œ ì§ì ‘ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” API ë…¸ì¶œ
    return {
        logPrompt: (projectRoot: string, prompt: string, title?: string) => {
            return savePrompt(projectRoot, prompt, title);
        }
    };
}

/**
 * í”„ë¡¬í”„íŠ¸ë¥¼ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ë¡œ ì €ì¥
 */
function savePrompt(projectRoot: string, prompt: string, title?: string): string {
    const promptsDir = path.join(projectRoot, 'prompts');
    if (!fs.existsSync(promptsDir)) {
        fs.mkdirSync(promptsDir, { recursive: true });
    }

    const date = new Date().toISOString().split('T')[0];
    const fileName = title
        ? `${date}_${title.toLowerCase().replace(/\s+/g, '_').replace(/[^\w-]/g, '')}.md`
        : `${date}_prompt_${Date.now()}.md`;

    const filePath = path.join(promptsDir, fileName);

    const content = `---
type: history
date: ${new Date().toLocaleString()}
tags: ["#Decision", "#Reasoning", "#Prompt"]
---

# ${title || 'Captured Design Prompt'}

## ğŸ’¬ Prompt
${prompt}

---
*Auto-generated by SYNAPSE Prompt Tracer*
`;

    fs.writeFileSync(filePath, content, 'utf-8');
    return filePath;
}

export function deactivate() { }
