/**
 * Bootstrap ì—”ì§„
 * GEMINI.md íŒŒì¼ì„ ì½ê³  ì „ì²´ ì´ˆê¸°í™” í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
 */

import * as path from 'path';
import * as fs from 'fs';
import { GeminiParser } from './GeminiParser';
import { FlowchartGenerator } from './FlowchartGenerator';
import { BootstrapResult, ProjectState } from '../types/schema';

export class BootstrapEngine {
    private parser: GeminiParser;
    private flowchartGen: FlowchartGenerator;

    constructor() {
        this.parser = new GeminiParser();
        this.flowchartGen = new FlowchartGenerator();
    }

    /**
     * Bootstrap í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
     * 1. GEMINI.md íŒŒì‹±
     * 2. ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
     * 3. ì´ˆê¸° ìˆœì„œë„ ìƒì„±
     */
    public async bootstrap(
        geminiMdPath: string,
        projectRoot: string,
        autoApprove: boolean = false
    ): Promise<BootstrapResult> {
        console.log('ğŸš€ SYNAPSE Bootstrap ì‹œì‘...');
        console.log(`  - GEMINI.md: ${geminiMdPath}`);
        console.log(`  - í”„ë¡œì íŠ¸ ë£¨íŠ¸: ${projectRoot}`);

        try {
            // 1. GEMINI.md íŒŒì‹±
            console.log('\n[1/3] GEMINI.md ë¶„ì„ ì¤‘...');
            const structure = await this.parser.parseGeminiMd(geminiMdPath);

            // 2. ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„± (ìŠ¹ì¸ í•„ìš”)
            if (autoApprove) {
                console.log('\n[2/3] ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„± ì¤‘...');
                await this.parser.createStructure(projectRoot, structure);
            } else {
                console.log('\n[2/3] ë””ë ‰í† ë¦¬ êµ¬ì¡° ì œì•ˆ:');
                this.printStructurePreview(structure);
                console.log('\nâš ï¸  ìŠ¹ì¸ ëŒ€ê¸° ì¤‘... (UIì—ì„œ [V] ë²„íŠ¼ í´ë¦­)');
            }

            // 3. ì´ˆê¸° ìˆœì„œë„ ìƒì„±
            console.log('\n[3/3] ì´ˆê¸° ìˆœì„œë„ ìƒì„± ì¤‘...');
            const { nodes, edges } = this.flowchartGen.generateInitialFlowchart(structure);

            // Mermaid ë‹¤ì´ì–´ê·¸ë¨ ìƒì„±
            const mermaidDiagram = this.flowchartGen.generateMermaidDiagram(nodes, edges);

            // ë‹¤ì´ì–´ê·¸ë¨ ì €ì¥
            const diagramPath = path.join(projectRoot, 'architecture.md');
            fs.writeFileSync(
                diagramPath,
                `# í”„ë¡œì íŠ¸ ì•„í‚¤í…ì²˜\n\nAuto-generated by SYNAPSE\n\n\`\`\`mermaid\n${mermaidDiagram}\`\`\`\n`,
                'utf-8'
            );
            console.log(`  âœ“ ë‹¤ì´ì–´ê·¸ë¨ ì €ì¥: ${diagramPath}`);

            // í”„ë¡œì íŠ¸ ìƒíƒœ ì €ì¥
            const projectState: ProjectState = {
                project_name: path.basename(projectRoot),
                gemini_md_path: geminiMdPath,
                canvas_state: {
                    zoom_level: 1.0,
                    offset: { x: 0, y: 0 },
                    visible_layers: ['source', 'documentation']
                },
                nodes,
                edges,
                clusters: []
            };

            const statePath = path.join(projectRoot, 'data', 'project_state.json');
            const stateDir = path.dirname(statePath);
            if (!fs.existsSync(stateDir)) {
                fs.mkdirSync(stateDir, { recursive: true });
            }
            fs.writeFileSync(statePath, JSON.stringify(projectState, null, 2), 'utf-8');
            console.log(`  âœ“ í”„ë¡œì íŠ¸ ìƒíƒœ ì €ì¥: ${statePath}`);

            console.log('\nâœ… Bootstrap ì™„ë£Œ!');
            console.log(`  - ë…¸ë“œ: ${nodes.length}ê°œ`);
            console.log(`  - ì—£ì§€: ${edges.length}ê°œ`);
            console.log(`  - ë‹¤ì´ì–´ê·¸ë¨: ${diagramPath}`);

            return {
                success: true,
                structure,
                initial_nodes: nodes,
                initial_edges: edges
            };

        } catch (error) {
            console.error('\nâŒ Bootstrap ì‹¤íŒ¨:', error);
            return {
                success: false,
                structure: { folders: [], files: [], dependencies: [] },
                initial_nodes: [],
                initial_edges: [],
                error: error instanceof Error ? error.message : String(error)
            };
        }
    }

    /**
     * êµ¬ì¡° ë¯¸ë¦¬ë³´ê¸° ì¶œë ¥
     */
    private printStructurePreview(structure: any): void {
        console.log('\nğŸ“‚ í´ë”:');
        structure.folders.forEach((folder: string) => {
            console.log(`  - ${folder}/`);
        });

        console.log('\nğŸ“„ íŒŒì¼:');
        structure.files.forEach((file: any) => {
            console.log(`  - ${file.path} (${file.type})`);
        });

        console.log('\nğŸ”— ì˜ì¡´ì„±:');
        structure.dependencies.forEach((dep: any) => {
            console.log(`  - ${dep.from} â†’ ${dep.to} (${dep.type})`);
        });
    }
}
